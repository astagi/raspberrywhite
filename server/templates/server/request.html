{% extends "server/base.html" %}

{% load static %}

{% block content %}

  <div class="container-fluid">
    <input class="form-control" placeholder="❤ ♬ Search the song you want to play ♬ ❤" id="songinput" ng-model="query" ng-change="search()">
    <div id="songlist" class="list-group"></div>
    {% verbatim %}
    <div class='list-group-item listelement' ng-repeat="song in songs"
        ng-click="sendrequest(song)" data-song-id='{{ song.id }}'>
      <div style='float:left;overflow: hidden; width: 80%; height: 50px;'>
        <h4 style='overflow: hidden; white-space: nowrap; text-overflow: ellipsis;' class='list-group-item-heading'>{{ song.artist }}</h4>
        <p class='list-group-item-text'>{{ song.title }}</p>
      </div>
    {% endverbatim %}
      <div style="float:right; width: 20%; text-align: right;">
        <img style="height:40px; white-space: nowrap;"
        src="{% static 'server/loading.gif' %}" ng-show="song.is_loading"/>
        <div style="height:40px; white-space: nowrap;" ng-hide="song.is_loading"></div>
      </div>
      <br style="clear: both"/>
    </div>
  </div>

  <script type="text/javascript">
    app.config(['$httpProvider', function($httpProvider) {
        $httpProvider.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token|escapejs }}';
        $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
    }]);
    app.controller('RaspiwhiteCtrl', function ($scope, $http) {
        $scope.nav = 'request';
        $scope.title = 'New request';
        $http.get("/songs/?term=")
          .success(function(data) {
            $scope.songs = data;
          });
        $scope.search = function() {
          $http.get("/songs/?term=" + $scope.query)
            .success(function(data) {
              $scope.songs = data;
            });
        }

        $scope.sendrequest = function(song) {
          $current_song = song;
          $current_song.is_loading = true;
          $http.post("/request/", $.param({ id_song: $current_song.id }))
            .success(function(data) {
              $current_song.is_loading = false;
            });
        }
    });

  </script>

{% endblock %}